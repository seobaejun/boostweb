<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ë¶€ìŠ¤íŠ¸ì›¹</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap"/>
    <link rel="shortcut icon" href="./assets/images/favicon.svg" type="image/svg+xml"/>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Plus Jakarta Sans', sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: #1a1a1a;
        border-radius: 16px;
        padding: 48px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid #2a2a2a;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
      }
      h1 {
        color: #ffffff;
        font-size: 32px;
        font-weight: 700;
      }
      .back-link {
        color: #ffffff;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: color 0.3s ease;
      }
      .back-link:hover {
        color: #7D3CF3;
      }
      .refresh-btn {
        padding: 10px 20px;
        background: #7D3CF3;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .refresh-btn:hover {
        background: #6b2dd9;
      }
      .refresh-btn:disabled {
        background: #555555;
        cursor: not-allowed;
      }
      .message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 24px;
        display: none;
        font-size: 14px;
      }
      .message.success {
        background: #4caf50;
        color: #ffffff;
        display: block;
      }
      .message.error {
        background: #f44336;
        color: #ffffff;
        display: block;
      }
      .section-title {
        color: #ffffff;
        font-size: 24px;
        font-weight: 700;
        margin: 32px 0 16px 0;
      }
      .data-table {
        width: 100%;
        margin-top: 24px;
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
      }
      th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #3a3a3a;
      }
      th {
        background: #1a1a1a;
        color: #ffffff;
        font-weight: 600;
        font-size: 14px;
      }
      td {
        color: #cccccc;
        font-size: 14px;
      }
      tr:hover {
        background: #2f2f2f;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge.admin {
        background: #7D3CF3;
        color: #ffffff;
      }
      .badge.user {
        background: #4caf50;
        color: #ffffff;
      }
      .badge.new {
        background: #2196F3;
        color: #ffffff;
      }
      .badge.processed {
        background: #ff9800;
        color: #ffffff;
      }
      .badge.premium {
        background: #ffd700;
        color: #1a1a1a;
      }
      .badge.free {
        background: #6c757d;
        color: #ffffff;
      }
      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 4px;
      }
      .action-btn.delete {
        background: #f44336;
        color: #ffffff;
      }
      .action-btn.delete:hover {
        background: #d32f2f;
      }
      .action-btn.status {
        background: #2196F3;
        color: #ffffff;
      }
      .action-btn.status:hover {
        background: #1976D2;
      }
      .action-btn.toggle {
        background: #ff9800;
        color: #ffffff;
      }
      .action-btn.toggle:hover {
        background: #f57c00;
      }
      .filter-buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
      }
      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #2a2a2a;
        color: #cccccc;
      }
      .filter-btn.active {
        background: #7D3CF3;
        color: #ffffff;
      }
      .filter-btn:hover {
        background: #3a3a3a;
      }
      .filter-btn.active:hover {
        background: #6b2dd9;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999999;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #999999;
      }
      .message-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        color: #7D3CF3;
        transition: color 0.3s ease;
      }
      .message-cell:hover {
        color: #6b2dd9;
        text-decoration: underline;
      }
      .message-detail {
        display: none;
        padding: 16px;
        background: #2a2a2a;
        border-top: 1px solid #3a3a3a;
        color: #cccccc;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .message-detail.expanded {
        display: table-cell;
      }
      tr.expanded-row .message-detail {
        display: table-cell;
      }
      tr.expanded-row {
        background: #2f2f2f;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <a href="index.html" class="back-link">
            â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </a>
          <h1 style="margin-top: 16px;">ê´€ë¦¬ì í˜ì´ì§€</h1>
        </div>
        <div style="display: flex; gap: 12px;">
          <button id="createTestUserBtn" class="refresh-btn" style="background: #4caf50;">í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„±</button>
          <button id="refreshBtn" class="refresh-btn">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      
      <div id="message" class="message"></div>
      
      <!-- íšŒì› ëª©ë¡ ì„¹ì…˜ -->
      <div id="usersSection">
        <h2 class="section-title">ğŸ‘¥ íšŒì› ëª©ë¡</h2>
        <div class="filter-buttons">
          <button class="filter-btn active" onclick="filterUsers('all', this)">ì „ì²´</button>
          <button class="filter-btn" onclick="filterUsers('premium', this)">ìœ ë£ŒíšŒì›</button>
          <button class="filter-btn" onclick="filterUsers('free', this)">ë¬´ë£ŒíšŒì›</button>
        </div>
        <div class="data-table">
          <div id="usersTableContainer" class="loading">ë¡œë”© ì¤‘...</div>
        </div>
      </div>
      
      <!-- ë¬¸ì˜ ë‚´ì—­ ì„¹ì…˜ -->
      <div id="contactsSection" style="margin-top: 48px;">
        <h2 class="section-title">ğŸ“ ë¬¸ì˜ ë‚´ì—­</h2>
        <div class="data-table">
          <div id="contactsTableContainer" class="loading">ë¡œë”© ì¤‘...</div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
      // ìƒìˆ˜ ì •ì˜ - ê´€ë¦¬ì ì´ë©”ì¼ ëª©ë¡
      const ADMIN_EMAILS = [
        'sprince1004@naver.com',      // ì„œë°°ì¤€ë‹˜
        'kylesung0901@gmail.com',      // ì„±ë¯¼ì„±ë‹˜
        'didalsdk1@naver.com'          // ì–‘ë¯¼ì•„ë‹˜
      ];

      // Firebase ì„¤ì •
      const firebaseConfig = {
        apiKey: "AIzaSyCQP1vx3cEtQUYOOqMsKS5HPM3SFMNxasY",
        authDomain: "boostweb-93027.firebaseapp.com",
        projectId: "boostweb-93027",
        storageBucket: "boostweb-93027.firebasestorage.app",
        messagingSenderId: "402354704129",
        appId: "1:402354704129:web:0c5cdd4f51b93ba4ef1500",
        measurementId: "G-2C1TW1KZ7X"
      };

      // Firebase ì´ˆê¸°í™”
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = message;
        messageDiv.className = 'message ' + type;
        messageDiv.style.display = 'block';
        
        if (type === 'success') {
          setTimeout(() => {
            messageDiv.style.display = 'none';
          }, 3000);
        }
      }

      // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
      function formatDate(timestamp) {
        if (!timestamp) return 'ì•Œ ìˆ˜ ì—†ìŒ';
        try {
          return new Date(timestamp.toDate()).toLocaleString('ko-KR');
        } catch (e) {
          return 'ì•Œ ìˆ˜ ì—†ìŒ';
        }
      }

      // íšŒì› ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      let usersUnsubscribe = null;
      
      function setupUsersRealtimeListener() {
        const usersTableContainer = document.getElementById('usersTableContainer');
        
        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë©´ ì œê±°
        if (usersUnsubscribe) {
          console.log('ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°');
          usersUnsubscribe();
          usersUnsubscribe = null;
        }
        
        if (!db) {
          console.error('Firestore ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
          usersTableContainer.innerHTML = '<div class="empty-state">Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        
        usersTableContainer.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
        
        console.log('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘...');
        console.log('Firestore ì¸ìŠ¤í„´ìŠ¤:', db ? 'ì¡´ì¬í•¨' : 'ì—†ìŒ');
        
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        try {
          usersUnsubscribe = db.collection('users').onSnapshot(
            (snapshot) => {
              console.log('=== íšŒì› ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì§€ ===');
              console.log('ì „ì²´ íšŒì› ìˆ˜:', snapshot.size, 'ëª…');
              console.log('ë³€ê²½ëœ ë¬¸ì„œ ìˆ˜:', snapshot.docChanges().length);
              
              // ë³€ê²½ ì‚¬í•­ ìƒì„¸ ë¡œê·¸
              snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                  const data = change.doc.data();
                  console.log('âœ… ìƒˆ íšŒì› ì¶”ê°€:', {
                    id: change.doc.id,
                    name: data.name,
                    email: data.email,
                    role: data.role,
                    referralId: data.referralId || 'ì—†ìŒ'
                  });
                } else if (change.type === 'modified') {
                  console.log('ğŸ“ íšŒì› ì •ë³´ ìˆ˜ì •:', change.doc.id);
                } else if (change.type === 'removed') {
                  console.log('âŒ íšŒì› ì‚­ì œ:', change.doc.id);
                }
              });
            
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‚ ì§œìˆœ ì •ë ¬
            const usersArray = [];
            snapshot.forEach(doc => {
              if (doc.exists) {
                usersArray.push({ id: doc.id, data: doc.data() });
              }
            });
            
            console.log('ì²˜ë¦¬í•  íšŒì› ìˆ˜:', usersArray.length);
            
            // ìµœì‹ ìˆœ ì •ë ¬
            usersArray.sort((a, b) => {
              try {
                const aTime = a.data.createdAt ? a.data.createdAt.toDate().getTime() : 0;
                const bTime = b.data.createdAt ? b.data.createdAt.toDate().getTime() : 0;
                return bTime - aTime;
              } catch (e) {
                return 0;
              }
            });
            
            if (usersArray.length === 0) {
              usersTableContainer.innerHTML = '<div class="empty-state">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
              console.log('íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            let tableHTML = '<table><thead><tr><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì—­í• </th><th>íšŒì› ìœ í˜•</th><th>ì¶”ì²œì¸ ID</th><th>ê°€ì…ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
            
            // XSS ë°©ì§€ë¥¼ ìœ„í•œ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
            const escapeHtml = (text) => {
              if (!text) return '-';
              const div = document.createElement('div');
              div.textContent = text;
              return div.innerHTML;
            };
            
            usersArray.forEach(item => {
              const userData = item.data;
              const userId = item.id;
              const createdAt = formatDate(userData.createdAt);
              const roleBadge = userData.role === 'admin' ? 
                '<span class="badge admin">Admin</span>' : 
                '<span class="badge user">User</span>';
              
              // íšŒì› ìœ í˜• í™•ì¸ (ê¸°ë³¸ê°’: free)
              const membershipType = userData.membershipType || 'free';
              const membershipBadge = membershipType === 'premium' ? 
                '<span class="badge premium">ìœ ë£Œ</span>' : 
                '<span class="badge free">ë¬´ë£Œ</span>';
              
              // ë””ë²„ê¹…: ê° ì‚¬ìš©ì ë°ì´í„° í™•ì¸
              console.log('ì‚¬ìš©ì ë°ì´í„° (ì‹¤ì‹œê°„):', {
                id: userId,
                name: userData.name,
                nameType: typeof userData.name,
                nameExists: userData.hasOwnProperty('name'),
                email: userData.email,
                referralId: userData.referralId,
                referralIdType: typeof userData.referralId,
                referralIdExists: userData.hasOwnProperty('referralId'),
                role: userData.role,
                membershipType: membershipType,
                ì „ì²´ë°ì´í„°: userData
              });
              
              // ì´ë¦„ê³¼ ì¶”ì²œì¸ ID í‘œì‹œ (ë” ëª…í™•í•œ ì²´í¬)
              let displayName = '-';
              if (userData.hasOwnProperty('name') && userData.name !== null && userData.name !== undefined) {
                const nameStr = String(userData.name).trim();
                if (nameStr.length > 0) {
                  displayName = nameStr;
                }
              }
              
              let displayReferralId = '-';
              if (userData.hasOwnProperty('referralId') && userData.referralId !== null && userData.referralId !== undefined) {
                const referralStr = String(userData.referralId).trim();
                if (referralStr.length > 0) {
                  displayReferralId = referralStr;
                }
              }
              
              console.log('í‘œì‹œí•  ê°’:', {
                displayName: displayName,
                displayReferralId: displayReferralId
              });
              
              const toggleBtnText = membershipType === 'premium' ? 'ë¬´ë£Œë¡œ ë³€ê²½' : 'ìœ ë£Œë¡œ ë³€ê²½';
              
              tableHTML += `
                <tr data-membership="${membershipType}">
                  <td>${escapeHtml(displayName)}</td>
                  <td>${escapeHtml(userData.email || '-')}</td>
                  <td>${roleBadge}</td>
                  <td>${membershipBadge}</td>
                  <td>${escapeHtml(displayReferralId)}</td>
                  <td>${createdAt}</td>
                  <td>
                    <button class="action-btn toggle" onclick="toggleMembership('${userId}', '${membershipType}')">${toggleBtnText}</button>
                    <button class="action-btn delete" onclick="deleteUser('${userId}', '${escapeHtml(userData.email || '')}')">ì‚­ì œ</button>
                  </td>
                </tr>
              `;
            });
            
              tableHTML += '</tbody></table>';
              usersTableContainer.innerHTML = tableHTML;
              console.log('âœ… íšŒì› ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', usersArray.length, 'ëª…');
            },
            (error) => {
              console.error('âŒ íšŒì› ëª©ë¡ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
              console.error('ì˜¤ë¥˜ ì½”ë“œ:', error.code);
              console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
              console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
              usersTableContainer.innerHTML = `<div class="empty-state">íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}<br>ì½”ë“œ: ${error.code || 'ì—†ìŒ'}</div>`;
              showMessage('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error');
            }
          );
          
          console.log('âœ… ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
        } catch (listenerError) {
          console.error('âŒ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘ ì˜¤ë¥˜:', listenerError);
          usersTableContainer.innerHTML = `<div class="empty-state">ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>${listenerError.message}</div>`;
          showMessage('ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜: ' + listenerError.message, 'error');
        }
      }
      
      // íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° í‘œì‹œ (Firestoreì—ì„œ)
      async function loadUsers() {
        const usersTableContainer = document.getElementById('usersTableContainer');
        usersTableContainer.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
        
        try {
          console.log('íšŒì› ëª©ë¡ ì¡°íšŒ ì‹œì‘...');
          console.log('Firestore ì¸ìŠ¤í„´ìŠ¤:', db ? 'ì¡´ì¬í•¨' : 'ì—†ìŒ');
          
          // Firestoreì—ì„œ ëª¨ë“  íšŒì› ì¡°íšŒ
          const usersSnapshot = await db.collection('users').get();
          console.log('ì¡°íšŒëœ íšŒì› ìˆ˜:', usersSnapshot.size);
          
          // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‚ ì§œìˆœ ì •ë ¬
          const usersArray = [];
          usersSnapshot.forEach(doc => {
            if (doc.exists) {
              const data = doc.data();
              usersArray.push({ 
                id: doc.id, 
                data: data 
              });
              console.log('íšŒì› ë°ì´í„°:', {
                id: doc.id,
                name: data.name,
                email: data.email,
                role: data.role
              });
            }
          });
          
          console.log('ì²˜ë¦¬í•  íšŒì› ìˆ˜:', usersArray.length);
          
          // ìµœì‹ ìˆœ ì •ë ¬
          usersArray.sort((a, b) => {
            try {
              const aTime = a.data.createdAt ? a.data.createdAt.toDate().getTime() : 0;
              const bTime = b.data.createdAt ? b.data.createdAt.toDate().getTime() : 0;
              return bTime - aTime;
            } catch (e) {
              return 0;
            }
          });
          
          if (usersArray.length === 0) {
            usersTableContainer.innerHTML = '<div class="empty-state">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            console.log('íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          let tableHTML = '<table><thead><tr><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì—­í• </th><th>íšŒì› ìœ í˜•</th><th>ì¶”ì²œì¸ ID</th><th>ê°€ì…ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
          
          // XSS ë°©ì§€ë¥¼ ìœ„í•œ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
          const escapeHtml = (text) => {
            if (!text) return '-';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };
          
          usersArray.forEach(item => {
            const userData = item.data;
            const userId = item.id;
            const createdAt = formatDate(userData.createdAt);
            const roleBadge = userData.role === 'admin' ? 
              '<span class="badge admin">Admin</span>' : 
              '<span class="badge user">User</span>';
            
            // íšŒì› ìœ í˜• í™•ì¸ (ê¸°ë³¸ê°’: free)
            const membershipType = userData.membershipType || 'free';
            const membershipBadge = membershipType === 'premium' ? 
              '<span class="badge premium">ìœ ë£Œ</span>' : 
              '<span class="badge free">ë¬´ë£Œ</span>';
            
            // ë””ë²„ê¹…: ê° ì‚¬ìš©ì ë°ì´í„° í™•ì¸
            console.log('ì‚¬ìš©ì ë°ì´í„° (loadUsers):', {
              id: userId,
              name: userData.name,
              nameType: typeof userData.name,
              nameExists: userData.hasOwnProperty('name'),
              email: userData.email,
              referralId: userData.referralId,
              referralIdType: typeof userData.referralId,
              referralIdExists: userData.hasOwnProperty('referralId'),
              role: userData.role,
              membershipType: membershipType,
              ì „ì²´ë°ì´í„°: userData
            });
            
            // ì´ë¦„ê³¼ ì¶”ì²œì¸ ID í‘œì‹œ (ë” ëª…í™•í•œ ì²´í¬)
            let displayName = '-';
            if (userData.hasOwnProperty('name') && userData.name !== null && userData.name !== undefined) {
              const nameStr = String(userData.name).trim();
              if (nameStr.length > 0) {
                displayName = nameStr;
              }
            }
            
            let displayReferralId = '-';
            if (userData.hasOwnProperty('referralId') && userData.referralId !== null && userData.referralId !== undefined) {
              const referralStr = String(userData.referralId).trim();
              if (referralStr.length > 0) {
                displayReferralId = referralStr;
              }
            }
            
            console.log('í‘œì‹œí•  ê°’ (loadUsers):', {
              displayName: displayName,
              displayReferralId: displayReferralId
            });
            
            const toggleBtnText = membershipType === 'premium' ? 'ë¬´ë£Œë¡œ ë³€ê²½' : 'ìœ ë£Œë¡œ ë³€ê²½';
            
            tableHTML += `
              <tr data-membership="${membershipType}">
                <td>${escapeHtml(displayName)}</td>
                <td>${escapeHtml(userData.email || '-')}</td>
                <td>${roleBadge}</td>
                <td>${membershipBadge}</td>
                <td>${escapeHtml(displayReferralId)}</td>
                <td>${createdAt}</td>
                <td>
                  <button class="action-btn toggle" onclick="toggleMembership('${userId}', '${membershipType}')">${toggleBtnText}</button>
                  <button class="action-btn delete" onclick="deleteUser('${userId}', '${escapeHtml(userData.email || '')}')">ì‚­ì œ</button>
                </td>
              </tr>
            `;
          });
          
          tableHTML += '</tbody></table>';
          usersTableContainer.innerHTML = tableHTML;
          console.log('íšŒì› ëª©ë¡ í‘œì‹œ ì™„ë£Œ:', usersArray.length, 'ëª…');
          
        } catch (error) {
          console.error('âŒ íšŒì› ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
          console.error('ì˜¤ë¥˜ ì½”ë“œ:', error.code);
          console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
          console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
          
          let errorMsg = 'íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          if (error.code === 'permission-denied') {
            errorMsg += '<br><br>âš ï¸ ê¶Œí•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤!<br>Firebase Console â†’ Firestore Database â†’ Rulesì—ì„œ ë‹¤ìŒ ê·œì¹™ì„ ì„¤ì •í•˜ê³  "ë°°í¬" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”:<br><br><code style="background: #2a2a2a; padding: 8px; border-radius: 4px; display: block; margin-top: 8px;">allow read, write: if true;</code>';
          } else if (error.code === 'unavailable') {
            errorMsg += '<br><br>âš ï¸ Firestore ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
          } else {
            errorMsg += `<br><br>ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}<br>ì½”ë“œ: ${error.code || 'ì—†ìŒ'}`;
          }
          
          usersTableContainer.innerHTML = `<div class="empty-state">${errorMsg}</div>`;
          showMessage('íšŒì› ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
        }
      }

      // ë¬¸ì˜ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ë° í‘œì‹œ
      async function loadContacts() {
        const contactsTableContainer = document.getElementById('contactsTableContainer');
        contactsTableContainer.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
        
        try {
          console.log('ë¬¸ì˜ ë‚´ì—­ ì¡°íšŒ ì‹œì‘...');
          
          // ëª¨ë“  ë¬¸ì˜ ë‚´ì—­ ì¡°íšŒ
          const contactsSnapshot = await db.collection('contacts').get();
          console.log('ë¬¸ì˜ ë‚´ì—­ ì¡°íšŒ ì™„ë£Œ, ë¬¸ì„œ ìˆ˜:', contactsSnapshot.size);
          
          // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‚ ì§œìˆœ ì •ë ¬
          const contactsArray = [];
          contactsSnapshot.forEach(doc => {
            if (doc.exists) {
              contactsArray.push({ id: doc.id, data: doc.data() });
            }
          });
          
          console.log('ë¬¸ì˜ ë°°ì—´ ìƒì„± ì™„ë£Œ, ê°œìˆ˜:', contactsArray.length);
          
          // ìµœì‹ ìˆœ ì •ë ¬
          contactsArray.sort((a, b) => {
            try {
              const aTime = a.data.createdAt ? a.data.createdAt.toDate().getTime() : 0;
              const bTime = b.data.createdAt ? b.data.createdAt.toDate().getTime() : 0;
              return bTime - aTime;
            } catch (e) {
              console.warn('ì •ë ¬ ì˜¤ë¥˜:', e);
              return 0;
            }
          });
          
          if (contactsArray.length === 0) {
            contactsTableContainer.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            console.log('ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          console.log('í…Œì´ë¸” ìƒì„± ì‹œì‘, ë¬¸ì˜ ê°œìˆ˜:', contactsArray.length);
          
          let tableHTML = '<table><thead><tr><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ì´ë©”ì¼</th><th>ë¬¸ì˜ë‚´ìš©</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
          
          // XSS ë°©ì§€ë¥¼ ìœ„í•œ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
          const escapeHtml = (text) => {
            if (!text) return '-';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };
          
          contactsArray.forEach((item, index) => {
            const contactData = item.data;
            const contactId = item.id;
            const createdAt = formatDate(contactData.createdAt);
            const currentStatus = contactData.status || 'new';
            const statusBadge = currentStatus === 'new' ? 
              '<span class="badge new">ì‹ ê·œ</span>' : 
              '<span class="badge processed">ì²˜ë¦¬ë¨</span>';
            const statusBtnText = currentStatus === 'new' ? 'ì²˜ë¦¬ì™„ë£Œ' : 'ì‹ ê·œë¡œ ë³€ê²½';
            const rowId = `contact-row-${index}`;
            const messageText = escapeHtml(contactData.message || '-');
            const shortMessage = contactData.message && contactData.message.length > 50 
              ? contactData.message.substring(0, 50) + '...' 
              : contactData.message || '-';
            
            tableHTML += `
              <tr id="${rowId}" class="contact-row">
                <td>${escapeHtml(contactData.name)}</td>
                <td>${escapeHtml(contactData.phone)}</td>
                <td>${escapeHtml(contactData.email)}</td>
                <td class="message-cell" onclick="toggleMessageDetail('${rowId}')" title="í´ë¦­í•˜ì—¬ ì „ì²´ ë‚´ìš© ë³´ê¸°">${escapeHtml(shortMessage)}</td>
                <td>${statusBadge}</td>
                <td>${createdAt}</td>
                <td>
                  <button class="action-btn status" onclick="toggleContactStatus('${contactId}', '${currentStatus}')">${statusBtnText}</button>
                  <button class="action-btn delete" onclick="deleteContact('${contactId}')">ì‚­ì œ</button>
                </td>
              </tr>
              <tr id="${rowId}-detail" class="message-detail-row" style="display: none;">
                <td colspan="7" class="message-detail">
                  <strong style="color: #7D3CF3;">ë¬¸ì˜ ë‚´ìš©:</strong><br>
                  ${messageText}
                </td>
              </tr>
            `;
          });
          
          tableHTML += '</tbody></table>';
          contactsTableContainer.innerHTML = tableHTML;
          console.log('ë¬¸ì˜ ë‚´ì—­ í‘œì‹œ ì™„ë£Œ');
          
        } catch (error) {
          console.error('ë¬¸ì˜ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:', error);
          console.error('ì˜¤ë¥˜ ìƒì„¸:', {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          contactsTableContainer.innerHTML = `<div class="empty-state">ë¬¸ì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div>`;
          // ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ì½˜ì†”ì—ë§Œ í‘œì‹œí•˜ê³  í™”ë©´ì—ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ (ì´ë¯¸ í‘œì‹œëœ ë°ì´í„°ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
        }
      }

      // íšŒì› ì‚­ì œ í•¨ìˆ˜
      async function deleteUser(userId, userEmail) {
        if (!confirm(`ì •ë§ë¡œ ${userEmail} íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }
        
        try {
          await db.collection('users').doc(userId).delete();
          showMessage('íšŒì›ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loadUsers();
        } catch (error) {
          console.error('íšŒì› ì‚­ì œ ì˜¤ë¥˜:', error);
          showMessage('íšŒì› ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
      }

      // ë¬¸ì˜ ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
      async function toggleContactStatus(contactId, currentStatus) {
        try {
          const newStatus = currentStatus === 'new' ? 'processed' : 'new';
          await db.collection('contacts').doc(contactId).update({
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          showMessage('ë¬¸ì˜ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loadContacts();
        } catch (error) {
          console.error('ë¬¸ì˜ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
          showMessage('ë¬¸ì˜ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
      }

      // ë¬¸ì˜ ì‚­ì œ í•¨ìˆ˜
      async function deleteContact(contactId) {
        if (!confirm('ì •ë§ë¡œ ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        try {
          await db.collection('contacts').doc(contactId).delete();
          showMessage('ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loadContacts();
        } catch (error) {
          console.error('ë¬¸ì˜ ì‚­ì œ ì˜¤ë¥˜:', error);
          showMessage('ë¬¸ì˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
      }

      // í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„± í•¨ìˆ˜ (users ì»¬ë ‰ì…˜ ìƒì„± í™•ì¸ìš©)
      async function createTestUser() {
        const createBtn = document.getElementById('createTestUserBtn');
        
        if (!auth.currentUser) {
          showMessage('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
          return;
        }
        
        if (!ADMIN_EMAILS.includes(auth.currentUser.email)) {
          showMessage('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
          return;
        }
        
        createBtn.disabled = true;
        createBtn.textContent = 'ìƒì„± ì¤‘...';
        
        try {
          // í…ŒìŠ¤íŠ¸ìš© ì¶”ì²œì¸ ID (ì˜ˆì‹œ)
          const testReferralId = 'test-referrer@example.com';
          
          const testUserData = {
            name: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
            email: 'test@example.com',
            role: 'user',
            membershipType: 'free',  // ê¸°ë³¸ê°’: ë¬´ë£ŒíšŒì›
            referralId: testReferralId,  // ì¶”ì²œì¸ ID í¬í•¨
            referredAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          console.log('í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„± ì‹œì‘...');
          console.log('ì €ì¥í•  ë°ì´í„°:', JSON.stringify(testUserData, null, 2));
          console.log('ì¶”ì²œì¸ ID:', testReferralId);
          
          // users ì»¬ë ‰ì…˜ì— í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ìƒì„±
          const testDocRef = db.collection('users').doc('test-user-' + Date.now());
          
          // set() ì‚¬ìš©
          await testDocRef.set(testUserData);
          console.log('âœ… í…ŒìŠ¤íŠ¸ ìœ ì € set() ì™„ë£Œ');
          
          // ì €ì¥ í™•ì¸
          await new Promise(resolve => setTimeout(resolve, 1000));
          const savedDoc = await testDocRef.get();
          
          if (savedDoc.exists) {
            const savedData = savedDoc.data();
            console.log('âœ… ì €ì¥ í™•ì¸ ì„±ê³µ!');
            console.log('ì €ì¥ëœ ë°ì´í„°:', JSON.stringify(savedData, null, 2));
            console.log('ì €ì¥ëœ ì¶”ì²œì¸ ID:', savedData.referralId || 'ì—†ìŒ');
            
            showMessage('í…ŒìŠ¤íŠ¸ ìœ ì €ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ì¶”ì²œì¸ ID í¬í•¨)', 'success');
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ loadUsers() í˜¸ì¶œ ë¶ˆí•„ìš”
          } else {
            showMessage('í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„±ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
          
        } catch (error) {
          console.error('í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„± ì˜¤ë¥˜:', error);
          console.error('ì˜¤ë¥˜ ì½”ë“œ:', error.code);
          console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
          showMessage('í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        } finally {
          createBtn.disabled = false;
          createBtn.textContent = 'í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„±';
        }
      }

      // ëª¨ë“  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadAllData() {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'ë¡œë”© ì¤‘...';
        
        // ê° í•¨ìˆ˜ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ (í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ê²ƒì€ ê³„ì† ì‹¤í–‰)
        const results = await Promise.allSettled([loadUsers(), loadContacts()]);
        
        // ê²°ê³¼ í™•ì¸
        const errors = results.filter(r => r.status === 'rejected');
        if (errors.length > 0) {
          console.warn('ì¼ë¶€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', errors);
        } else {
          console.log('ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        }
        
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
      
      // ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘
      function startRealtimeUpdates() {
        console.log('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ');
        try {
          if (!db) {
            console.error('Firestore ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
            showMessage('Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
          }
          setupUsersRealtimeListener();
          console.log('íšŒì› ëª©ë¡ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘ ì™„ë£Œ');
        } catch (error) {
          console.error('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘ ì˜¤ë¥˜:', error);
          console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message, error.stack);
          showMessage('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
        // contactsë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì¶”ê°€
      }

      // ë¬¸ì˜ ë‚´ìš© ìƒì„¸ ë³´ê¸° í† ê¸€ í•¨ìˆ˜
      function toggleMessageDetail(rowId) {
        const detailRow = document.getElementById(rowId + '-detail');
        const mainRow = document.getElementById(rowId);
        
        if (detailRow && mainRow) {
          if (detailRow.style.display === 'none') {
            detailRow.style.display = 'table-row';
            mainRow.classList.add('expanded-row');
          } else {
            detailRow.style.display = 'none';
            mainRow.classList.remove('expanded-row');
          }
        }
      }

      // íšŒì› ìœ í˜• ì „í™˜ í•¨ìˆ˜
      async function toggleMembership(userId, currentType) {
        try {
          const newType = currentType === 'premium' ? 'free' : 'premium';
          const typeName = newType === 'premium' ? 'ìœ ë£Œ' : 'ë¬´ë£Œ';
          
          if (!confirm(`ì´ íšŒì›ì„ ${typeName}íšŒì›ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
          }
          
          await db.collection('users').doc(userId).update({
            membershipType: newType,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          showMessage(`íšŒì› ìœ í˜•ì´ ${typeName}íšŒì›ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
          // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ë³„ë„ ë¡œë“œ ë¶ˆí•„ìš”
        } catch (error) {
          console.error('íšŒì› ìœ í˜• ë³€ê²½ ì˜¤ë¥˜:', error);
          showMessage('íšŒì› ìœ í˜• ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
      }

      // íšŒì› ëª©ë¡ í•„í„°ë§ í•¨ìˆ˜
      let currentFilter = 'all';
      function filterUsers(filterType, eventElement) {
        currentFilter = filterType;
        
        // í•„í„° ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        if (eventElement) {
          eventElement.classList.add('active');
        } else {
          // onclickì—ì„œ í˜¸ì¶œëœ ê²½ìš°
          const buttons = document.querySelectorAll('.filter-btn');
          buttons.forEach(btn => {
            if (btn.textContent.trim() === (filterType === 'all' ? 'ì „ì²´' : filterType === 'premium' ? 'ìœ ë£ŒíšŒì›' : 'ë¬´ë£ŒíšŒì›')) {
              btn.classList.add('active');
            }
          });
        }
        
        // í…Œì´ë¸” í–‰ í•„í„°ë§
        const tableRows = document.querySelectorAll('#usersTableContainer table tbody tr');
        tableRows.forEach(row => {
          const membership = row.getAttribute('data-membership') || 'free';
          
          if (filterType === 'all') {
            row.style.display = '';
          } else if (filterType === 'premium' && membership === 'premium') {
            row.style.display = '';
          } else if (filterType === 'free' && membership === 'free') {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (onclickì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´)
      window.deleteUser = deleteUser;
      window.toggleContactStatus = toggleContactStatus;
      window.deleteContact = deleteContact;
      window.toggleMessageDetail = toggleMessageDetail;
      window.toggleMembership = toggleMembership;
      window.filterUsers = filterUsers;

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.getElementById('refreshBtn').addEventListener('click', loadAllData);
      document.getElementById('createTestUserBtn').addEventListener('click', createTestUser);

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
      auth.onAuthStateChanged(function(user) {
        if (user && ADMIN_EMAILS.includes(user.email)) {
          console.log('ê´€ë¦¬ì ë¡œê·¸ì¸ í™•ì¸, ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘');
          console.log('í˜„ì¬ ì‚¬ìš©ì:', user.email);
          
          // ë¨¼ì € ì´ˆê¸° ë°ì´í„° ë¡œë“œ
          loadAllData();
          
          // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘ (íšŒì›ê°€ì… ì‹œ ìë™ìœ¼ë¡œ í‘œì‹œë¨)
          setTimeout(() => {
            startRealtimeUpdates();
            console.log('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘ ì™„ë£Œ');
          }, 500);
        } else if (user) {
          showMessage('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
          document.body.innerHTML = '<div class="container"><h1 style="color: #ffffff; text-align: center; padding: 40px;">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h1></div>';
        } else {
          window.location.href = 'login.html';
        }
      });
      
      // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
      window.addEventListener('beforeunload', function() {
        if (usersUnsubscribe) {
          usersUnsubscribe();
        }
      });
    </script>
  </body>
</html>
